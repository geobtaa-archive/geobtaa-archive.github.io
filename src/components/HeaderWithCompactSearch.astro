---
import config from 'virtual:starlight/user-config';

import LanguageSelect from 'virtual:starlight/components/LanguageSelect';
import Search from 'virtual:starlight/components/Search';
import SiteTitle from 'virtual:starlight/components/SiteTitle';
import SocialIcons from 'virtual:starlight/components/SocialIcons';
import ThemeSelect from 'virtual:starlight/components/ThemeSelect';
import {
  PRIMARY_NAV_OPTIONS,
  deriveGroupFromPath,
  type NavGroupId,
} from '../../navigation.config';

const shouldRenderSearch =
  config.pagefind || config.components.Search !== '@astrojs/starlight/components/Search.astro';

const navOptions = PRIMARY_NAV_OPTIONS;

const activeNavGroup: NavGroupId = deriveGroupFromPath(Astro.url.pathname);
---

<div class="header">
  <div class="title-group">
    <div class="title-wrapper sl-flex">
      <SiteTitle />
    </div>
    <nav class="top-nav top-nav--header sl-hidden md:sl-flex" aria-label="Primary navigation">
      {
        navOptions.map(({ label, group, target }) => (
          <a
            class="top-nav__item"
            href={target}
            data-nav-group={group}
            data-active={activeNavGroup === group ? 'true' : undefined}
            aria-current={activeNavGroup === group ? 'page' : undefined}
          >
            {label}
          </a>
        ))
      }
    </nav>
  </div>
  <div class="header-actions sl-flex print:hidden">
    {shouldRenderSearch && (
      <div class="search-container">
        <Search class="compact-search" />
      </div>
    )}
    <div class="sl-hidden md:sl-flex right-group">
      <div class="sl-flex social-icons">
        <SocialIcons />
      </div>
      <ThemeSelect />
      <LanguageSelect />
    </div>
  </div>
</div>

<style>
  @layer starlight.core {
    .header {
      display: flex;
      gap: var(--sl-nav-gap);
      justify-content: space-between;
      align-items: center;
      flex-wrap: nowrap;
      height: 100%;
    }

    .title-group {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      min-width: 0;
    }

    .title-wrapper {
      overflow: clip;
      padding: 0.25rem;
      margin: -0.25rem;
      min-width: 0;
    }

    .header-actions {
      align-items: center;
      gap: 0.75rem;
    }

    .search-container {
      flex: 1 1 auto;
      min-width: 0;
    }

    .right-group,
    .social-icons {
      gap: 1rem;
      align-items: center;
    }

    .social-icons::after {
      content: '';
      height: 2rem;
      border-inline-end: 1px solid var(--sl-color-gray-5);
    }

    @media (min-width: 50rem) {
      :global(:root[data-has-sidebar]) {
        --__sidebar-pad: calc(2 * var(--sl-nav-pad-x));
      }
      :global(:root:not([data-has-toc])) {
        --__toc-width: 0rem;
      }
      .header {
        --__sidebar-width: max(0rem, var(--sl-content-inline-start, 0rem) - var(--sl-nav-pad-x));
        --__main-column-fr: calc(
          (
              100% + var(--__sidebar-pad, 0rem) - var(--__toc-width, var(--sl-sidebar-width)) -
                (2 * var(--__toc-width, var(--sl-nav-pad-x))) - var(--sl-content-inline-start, 0rem) -
                var(--sl-content-width)
            ) / 2
        );
        display: grid;
        grid-template-columns:
          minmax(
            calc(var(--__sidebar-width) + max(0rem, var(--__main-column-fr) - var(--sl-nav-gap))),
            auto
          )
          1fr
          auto;
        align-content: center;
      }

      .title-group {
        gap: 1.75rem;
      }

      .header-actions {
        justify-content: flex-end;
        gap: 1rem;
      }

      .search-container {
        flex: 0 0 auto;
        width: min(14rem, 100%);
      }
    }
  }

  :global(.top-nav) {
    align-items: center;
    gap: 1.75rem;
    margin: 0;
    flex-wrap: wrap;
    --top-nav-item-color: var(--sl-color-text);
    --top-nav-item-active: var(--sl-color-text-accent);
    --top-nav-indicator: var(--sl-color-text-accent);
  }

  :global(.top-nav__item) {
    border: 0;
    background: none;
    text-decoration: none;
    padding: 0.45rem 0.25rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--top-nav-item-color);
    cursor: pointer;
    position: relative;
    line-height: 1.1;
    transition: color 150ms ease, transform 150ms ease;
  }

  :global(.top-nav__item)::after {
    content: '';
    position: absolute;
    inset-inline: 0.35rem;
    bottom: -0.1rem;
    height: 2px;
    border-radius: 999px;
    background: transparent;
    transition: background-color 150ms ease, opacity 150ms ease;
    opacity: 0;
  }

  :global(.top-nav__item:hover),
  :global(.top-nav__item:focus-visible) {
    color: var(--top-nav-item-active);
  }

  :global(.top-nav__item:focus-visible) {
    outline: 2px solid color-mix(in srgb, var(--top-nav-item-active) 60%, transparent);
    outline-offset: 4px;
  }

  :global(.top-nav__item[data-active='true']) {
    color: var(--top-nav-item-active);
  }

  :global(.top-nav__item[data-active='true'])::after {
    background: var(--top-nav-indicator);
    opacity: 1;
  }

  :global(.top-nav--header) {
    --top-nav-item-color: var(--sl-color-gray-2);
    --top-nav-item-active: var(--sl-color-text-accent);
    --top-nav-indicator: var(--sl-color-text-accent);
  }

  :global(:root[data-theme='light'] .top-nav--header) {
    --top-nav-item-color: rgba(255, 255, 255, 0.75);
    --top-nav-item-active: #ffffff;
    --top-nav-indicator: #ffffff;
  }

  :global(:root[data-theme='dark'] .top-nav--header) {
    --top-nav-item-color: var(--sl-color-gray-2);
    --top-nav-item-active: var(--sl-color-white);
    --top-nav-indicator: var(--sl-color-white);
  }

  :global(.top-nav--drawer) {
    width: 100%;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.75rem;
    padding: 0.65rem var(--sl-nav-pad-x);
    margin-top: 0.75rem;
    margin-bottom: 1.75rem;
    border-top: 1px solid color-mix(in srgb, var(--sl-color-hairline) 50%, transparent);
    border-bottom: 1px solid color-mix(in srgb, var(--sl-color-hairline) 40%, transparent);
    background: var(--sl-color-bg);
    --top-nav-item-color: var(--sl-color-text);
    --top-nav-item-active: var(--sl-color-text-accent);
    --top-nav-indicator: var(--sl-color-text-accent);
  }

  :global(.top-nav--drawer .top-nav__item) {
    flex: 1 1 calc(33.333% - 0.75rem);
    font-size: 1rem;
    padding: 0.55rem 0.75rem;
    border-radius: 999px;
    border: 1px solid color-mix(in srgb, var(--sl-color-hairline) 55%, transparent);
    background: color-mix(in srgb, var(--top-nav-item-active) 10%, transparent);
  }

  :global(.top-nav--drawer .top-nav__item[data-active='true']) {
    background: color-mix(in srgb, var(--top-nav-item-active) 20%, transparent);
  }

  :global(:root[data-theme='dark'] .top-nav--drawer) {
    background: var(--sl-color-bg-nav);
    border-top-color: color-mix(in srgb, var(--sl-color-hairline) 40%, transparent);
    border-bottom-color: color-mix(in srgb, var(--sl-color-hairline) 30%, transparent);
  }
</style>
